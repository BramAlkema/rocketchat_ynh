{"version":3,"sources":["meteor://ğŸ’»app/server/methods/loadSurroundingMessages.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,2BAAyB,SAAC,OAAD,EAAU,KAAV;AACxB;;MADkC,QAAM;KACxC;AAAA,aAAS,MAAM,CAAC,MAAP,EAAT;AAEA,gBAAc,CAAC,GAAf;AACC,aAAO,KAAP,CADD;KAFA;AAAA,IAKA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,WAA3B,CAAuC,OAAO,CAAC,GAA/C,CALV;AAOA,4BAAO,OAAO,CAAE,aAAhB;AACC,aAAO,KAAP,CADD;KAPA;AAUA,eAAa,CAAC,IAAP,CAAY,eAAZ,EAA6B,OAAO,CAAC,GAArC,EAA0C,MAA1C,CAAP;AACC,aAAO,KAAP,CADD;KAVA;AAAA,IAaA,QAAQ,QAAQ,CAbhB;AAAA,IAeA,UACC;AAAA,YACC;AAAA,YAAI,EAAJ;OADD;AAAA,MAEA,OAAO,IAAI,CAAC,IAAL,CAAU,QAAM,CAAhB,CAFP;KAhBD;AAoBA,QAAG,WAAc,CAAC,QAAQ,CAAC,GAApB,CAAwB,0BAAxB,CAAP;AACC,aAAO,CAAC,MAAR,GAAiB;AAAA,QAAE,YAAY,CAAd;OAAjB,CADD;KApBA;AAAA,IAuBA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,kCAA3B,CAA8D,OAAO,CAAC,GAAtE,EAA2E,OAAO,CAAC,EAAnF,EAAuF,OAAvF,CAA+F,CAAC,KAAhG,EAvBV;AAAA,IAwBA,WAAW,CAAC,CAAC,GAAF,CAAM,OAAN,EAAe,SAAC,OAAD;AACzB,aAAO,CAAC,OAAR,GAAkB,CAAC,CAAC,SAAF,CAAY,OAAO,CAAC,OAApB,EAA6B;AAAA,QAAE,KAAK,MAAP;OAA7B,CAAlB;AACA,aAAO,OAAP,CAFyB;IAAA,CAAf,CAxBX;AAAA,IA4BA,aAAa,QAAQ,CAAC,MAAT,KAAmB,OAAO,CAAC,KA5BxC;AAAA,IA8BA,QAAQ,CAAC,IAAT,CAAc,OAAd,CA9BA;AAAA,IAgCA,OAAO,CAAC,IAAR,GAAe;AAAA,MAAE,IAAI,CAAN;KAhCf;AAAA,IAiCA,OAAO,CAAC,KAAR,GAAgB,IAAI,CAAC,KAAL,CAAW,QAAM,CAAjB,CAjChB;AAAA,IAmCA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,iCAA3B,CAA6D,OAAO,CAAC,GAArE,EAA0E,OAAO,CAAC,EAAlF,EAAsF,OAAtF,CAA8F,CAAC,KAA/F,EAnCV;AAAA,IAoCA,gBAAgB,CAAC,CAAC,GAAF,CAAM,OAAN,EAAe,SAAC,OAAD;AAC9B,aAAO,CAAC,OAAR,GAAkB,CAAC,CAAC,SAAF,CAAY,OAAO,CAAC,OAApB,EAA6B;AAAA,QAAE,KAAK,MAAP;OAA7B,CAAlB;AACA,aAAO,OAAP,CAF8B;IAAA,CAAf,CApChB;AAAA,IAwCA,YAAY,aAAa,CAAC,MAAd,KAAwB,OAAO,CAAC,KAxC5C;AAAA,IA0CA,WAAW,QAAQ,CAAC,MAAT,CAAgB,aAAhB,CA1CX;AA4CA,WAAO;AAAA,MACN,UAAU,QADJ;AAAA,MAEN,YAAY,UAFN;AAAA,MAGN,WAAW,SAHL;KAAP,CA7CwB;EAAA,CAAzB;CADD","file":"/server/methods/loadSurroundingMessages.coffee.js","sourcesContent":["Meteor.methods\n\tloadSurroundingMessages: (message, limit=50) ->\n\t\tfromId = Meteor.userId()\n\n\t\tunless message._id\n\t\t\treturn false\n\n\t\tmessage = RocketChat.models.Messages.findOneById(message._id);\n\n\t\tunless message?.rid\n\t\t\treturn false\n\n\t\tunless Meteor.call 'canAccessRoom', message.rid, fromId\n\t\t\treturn false\n\n\t\tlimit = limit - 1\n\n\t\toptions =\n\t\t\tsort:\n\t\t\t\tts: -1\n\t\t\tlimit: Math.ceil(limit/2)\n\n\t\tif not RocketChat.settings.get 'Message_ShowEditedStatus'\n\t\t\toptions.fields = { 'editedAt': 0 }\n\n\t\trecords = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestamp(message.rid, message.ts, options).fetch()\n\t\tmessages = _.map records, (message) ->\n\t\t\tmessage.starred = _.findWhere message.starred, { _id: fromId }\n\t\t\treturn message\n\n\t\tmoreBefore = messages.length is options.limit\n\n\t\tmessages.push message\n\n\t\toptions.sort = { ts: 1 }\n\t\toptions.limit = Math.floor(limit/2)\n\n\t\trecords = RocketChat.models.Messages.findVisibleByRoomIdAfterTimestamp(message.rid, message.ts, options).fetch()\n\t\tafterMessages = _.map records, (message) ->\n\t\t\tmessage.starred = _.findWhere message.starred, { _id: fromId }\n\t\t\treturn message\n\n\t\tmoreAfter = afterMessages.length is options.limit\n\n\t\tmessages = messages.concat afterMessages\n\n\t\treturn {\n\t\t\tmessages: messages\n\t\t\tmoreBefore: moreBefore\n\t\t\tmoreAfter: moreAfter\n\t\t}\n"]}